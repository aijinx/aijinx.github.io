<!DOCTYPE html>
<html>
<head>
    <title>Get TSLA Data</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- W3css, ajax, react, bootstrap, jquery, google maps, google login-->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=myMap"></script>
    <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.6.3/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.6.3/umd/react-dom.production.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="w3-container">
        <h2>Get TSLA Data</h2>
        <table></table>
    <script>
        async function printDataToDOM(data) {
            const table = document.querySelector('table');
            const timeSeries = data['Time Series (Daily)'];
            for (const date in timeSeries) {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td');
                const td2 = document.createElement('td');
                const td3 = document.createElement('td');
                const td4 = document.createElement('td');
                const td5 = document.createElement('td');
                td1.textContent = date;
                td2.textContent = timeSeries[date]['1. open'];
                td3.textContent = timeSeries[date]['2. high'];
                td4.textContent = timeSeries[date]['3. low'];
                td5.textContent = timeSeries[date]['4. close'];
                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                table.appendChild(tr);
            }
        }
        async function saveToIndexedDB(key, val) {
            const db = await idb.openDB('TSLA', 1, {
                upgrade(db) {
                    db.createObjectStore('TSLA');
                },
            });
            await db.put('TSLA', val, key);
            alert('Data saved to indexedDB')
        }
        async function getFromIndexedDB(key) {
            const db = await idb.openDB('TSLA', 1);
            return db.get('TSLA', key);
        }
        async function getTSLAData() {
            const data = await getFromIndexedDB('TSLA');
            if (data) {
                printDataToDOM(data);
            } else {
                axios.get('https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=TSLA&apikey=V476E4UJS67XBTL9&interval=1min,outputsize=full&datatype=json')
                    .then(function (response) {
                        saveToIndexedDB('TSLA', response.data);
                        printDataToDOM(response.data);
                    })
                    .catch(function (error) {
                        alert(error);
                    });
            }
        }
        async function getLast60MinutesData() {
            const data = await getFromIndexedDB('TSLA');
            const timeSeries = data['Time Series (1min)'];
            const last60Minutes = Object.keys(timeSeries).slice(0, 60);
            const last60MinutesData = last60Minutes.map((date) => {
                return {
                    date,
                    open: timeSeries[date]['1. open'],
                    high: timeSeries[date]['2. high'],
                    low: timeSeries[date]['3. low'],
                    close: timeSeries[date]['4. close'],
                };
            });
            // console.log(last60MinutesData);
        }
        window.onload = getTSLAData;
    </script>
    </div>
</body>
</html>